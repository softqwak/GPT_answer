Защита от XSS (межсайтового скриптинга) требует соблюдения нескольких правил на уровне серверной части, клиентской части, а также на уровне настройки веб-сервера. Вот пошаговый план для реализации защиты в вашем проекте:

---

### **1. Очистка и валидация входных данных**
Убедитесь, что все данные, получаемые от пользователя (включая формы, параметры URL, заголовки запросов, куки), проходят проверку.

- **Валидация данных**:
  - Разрешайте только допустимые значения (например, числовые значения для ID, формат email для электронной почты).
  - Используйте библиотеки в FastAPI для валидации данных, например `Pydantic` (уже используется в FastAPI).

```python
from pydantic import BaseModel, EmailStr

class UserInput(BaseModel):
    email: EmailStr
    age: int
```

- **Очистка данных**:
  - Удаляйте или экранируйте нежелательные символы, например `<`, `>`, `'`, `"` и другие.
  - Для вывода данных в HTML используйте экранирование (например, `html.escape` в Python).

```python
import html

user_input = "<script>alert('xss')</script>"
safe_input = html.escape(user_input)  # &lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;
```

---

### **2. Content Security Policy (CSP)**
CSP — мощный инструмент для предотвращения выполнения вредоносных скриптов. Он ограничивает, откуда браузер может загружать ресурсы.

- **Пример заголовка CSP**:
  Установите заголовок ответа для вашего сервера.

```
Content-Security-Policy: default-src 'self'; script-src 'self' https://trusted-scripts.example.com; object-src 'none'; base-uri 'self';
```

- **Разъяснение**:
  - `default-src 'self'`: разрешает загрузку контента только с вашего домена.
  - `script-src 'self' https://trusted-scripts.example.com`: разрешает скрипты только с вашего домена и указанного доверенного источника.
  - `object-src 'none'`: запрещает использование `<object>`, `<embed>` и `<applet>`.
  - `base-uri 'self'`: запрещает переопределение `<base>` URL.

---

### **3. Использование флагов для cookies**
Ваши cookies с сессионным ID уже защищены `HttpOnly`, `Secure` и `SameSite`, что снижает риск кражи cookies через XSS. 

Пример настройки в FastAPI:

```python
from fastapi.responses import Response

response = Response("Hello, World!")
response.set_cookie(
    key="session_id",
    value="example-session-id",
    httponly=True,
    secure=True,
    samesite="Lax"
)
```

---

### **4. Экранирование выходных данных**
Любые данные, которые отображаются на странице, должны быть экранированы.

- **HTML-шаблоны Jinja2**:
  Встроенное экранирование включено по умолчанию. Например:

```html
<p>{{ user_input }}</p>
```

Это автоматически экранирует ввод.

---

### **5. Запрет inline-скриптов**
Inline-скрипты являются основным вектором XSS-атак. Убедитесь, что в вашем проекте:

- Нет использования атрибутов вроде `onclick`, `onload`.
- Inline-скрипты заменены на внешние файлы или объявления в тегах `<script>`.

Если нужно использовать inline-скрипты, защитите их через CSP с хэшем:

```html
<script>
    console.log('Hello, safe script!');
</script>
```

И добавьте в CSP:

```
Content-Security-Policy: script-src 'sha256-<HASH>';
```

Где `<HASH>` — это SHA256-хэш скрипта.

---

### **6. Защита API от XSS**
Если ваш сайт использует API (например, с FastAPI), убедитесь, что:

- Все выходные данные экранированы.
- Заголовки, такие как `Content-Type`, устанавливаются правильно (`application/json`, `text/html`).

---

### **7. Использование библиотек и инструментов**
Для обработки ввода и защиты используйте проверенные библиотеки:
- **Python**:
  - `html.escape` для экранирования данных.
  - `Bleach` для безопасной очистки HTML (например, если вы позволяете пользователям добавлять разметку).
- **FastAPI**:
  - Убедитесь, что в шаблонах Jinja2 включено автоэкранирование.

---

### **8. Обновление зависимостей**
Регулярно обновляйте все сторонние библиотеки и фреймворки, чтобы устранить уязвимости.

---

### **9. Тестирование на XSS**
Используйте автоматизированные сканеры (например, OWASP ZAP или Burp Suite) для проверки вашего сайта на уязвимости XSS.

---

### **Итог**
Соблюдение этих мер значительно снизит вероятность XSS-атак. Однако основное внимание следует уделить экранированию выходных данных, CSP и очистке входных данных. Если у вас небольшое приложение, базовые меры, такие как настройка CSP, экранирование и защита cookies, будут достаточно эффективными.